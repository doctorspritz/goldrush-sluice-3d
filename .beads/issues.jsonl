{"id":"sluice-2z8","title":"Deposition suppression too aggressive in shallow water","description":"## Problem\nDeposition is overly suppressed in shallow water conditions, preventing natural sediment accumulation even when flow velocity is low.\n\n## Location\n`crates/sim3d/src/world.rs` - deposition calculation\n\n## Impact\nUnrealistic sediment transport, gold doesn't settle in shallows.\n\n## Solution\nReview deposition threshold and shallow water handling.","status":"open","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:35:01.475334+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:35:01.475334+10:00"}
{"id":"sluice-351","title":"Pressure solver has no convergence monitoring","description":"## Problem\nPressure solver runs exactly 40 iterations with no residual check. May under-iterate, over-iterate, or diverge silently.\n\n## Location\n`flip_3d.rs` line 4167: `self.pressure.encode(encoder, 40)`\n\n## Impact\n- Wastes GPU cycles if converged early\n- Produces garbage if system is diverging\n- 40 iterations may be insufficient for large domains\n\n## Fix\nAdd residual reduction pass, terminate early if converged, warn if diverging.","status":"open","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:52.888287+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:41:52.888287+10:00"}
{"id":"sluice-3o2","title":"Shear stress calculation adds two incompatible formulas","description":"## Problem\nShear stress combines gravity term and velocity term additively, but these are ALTERNATIVE formulations for the same quantity.\n\n## Location\n`world.rs` lines 520-524\n\n## Current (wrong)\n```rust\nlet grav_term = g * water_depth * slope;\nlet velocity_term = cf * (vx*vx + vz*vz);\nlet shear_stress = rho * (grav_term + velocity_term);  // WRONG: additive\n```\n\n## Correct\nChoose ONE approach:\n- Slope-based: tau = rho * g * h * S\n- OR Velocity-based: tau = rho * Cf * v^2\n\n## Fix\nUse velocity-based formula only (more accurate for non-uniform flow).","status":"open","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:52.322217+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:41:52.322217+10:00"}
{"id":"sluice-42e","title":"Fixed-point atomic overflow risk in P2G scatter","description":"## Problem\nIn `p2g_scatter_3d.wgsl`, fixed-point atomics use SCALE=1,000,000 with i32 max ~2.1e9. With high particle counts (100k+) accumulating in single cells, overflow is possible.\n\n## Location\n`crates/game/src/gpu/shaders/p2g_scatter_3d.wgsl`\n\n## Risk\nSilent data corruption, unstable simulation.\n\n## Solution\nUse i64 atomics or reduce SCALE factor with saturation checks.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:30.61681+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:34:30.61681+10:00"}
{"id":"sluice-4t4","title":"CRITICAL: Cell type constant mismatch between multigrid and main shaders","description":"## Problem\nMultigrid pressure solver shaders use CELL_SOLID=0, but main 3D shaders use CELL_SOLID=2. This causes completely wrong boundary conditions.\n\n## Locations\n- mg_smooth.wgsl, mg_residual.wgsl, mg_prolongate.wgsl, mg_restrict.wgsl, pcg_ops.wgsl: CELL_SOLID=0\n- All main shaders (p2g, g2p, pressure, etc.): CELL_SOLID=2\n\n## Impact\n- AIR cells (0) treated as SOLID in multigrid\n- SOLID cells (2) treated as AIR\n- Completely wrong pressure solve with multigrid preconditioner\n\n## Fix\nUnify all shaders to use CELL_SOLID=2 (or 0, but consistently).","status":"open","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:49.366491+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:41:49.366491+10:00"}
{"id":"sluice-4zy","title":"Parallel array desync between sediment_flip_indices and dem.clumps","description":"## Problem\nWhen multiple sediment particles are deleted in one frame, swap_remove on parallel arrays (sediment_flip_indices and dem.clumps) can desync them.\n\n## Location\n`main.rs` lines 744-791\n\n## Mechanism\n1. Delete particle at index 100, sediment_pos=5\n2. clumps.swap_remove(5) - clump 8 moves to 5\n3. sediment_flip_indices.swap_remove(5) - index 8 moves to 5\n4. Delete particle at index 50, sediment_pos=3\n5. clumps.swap_remove(3) - clump 7 moves to 3\n6. BUT clump 7 was ALREADY remapped in step 2!\n\n## Impact\nWrong DEM clumps receive FLIP velocities. Sediment physics corruption.\n\n## Fix\nUse generational indices or store DEM clump index directly in FLIP particle.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:50.572739+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:41:50.572739+10:00"}
{"id":"sluice-59h","title":"Replace linked-list spatial hash","description":"Use prefix-sum dense array instead of linked-list. 15-20% speedup expected.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:23.790013+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:15:23.790013+10:00"}
{"id":"sluice-6cp","title":"Missing architecture documentation","description":"## Problem\nNo high-level architecture overview. New developers cannot understand system structure. Missing documentation for:\n- GPU pipeline stages\n- Data flow between CPU/GPU\n- Shader organization\n- Sediment physics model\n\n## Solution\nCreate docs/ARCHITECTURE.md with diagrams and explanations.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:35:00.907694+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:35:00.907694+10:00"}
{"id":"sluice-7al","title":"GPU/CPU state divergence in async readback","description":"## Problem\nAsync GPU readback with double-buffered slots can leave CPU state stale for 2+ frames. If GPU fails to signal completion, CPU may read garbage or outdated data.\n\n## Location\n`crates/game/src/gpu/flip_3d.rs` - ReadbackSlot logic\n\n## Risk\nCorrupted particle data, physics glitches.\n\n## Solution\nAdd fence synchronization or timeout detection with graceful degradation.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:31.156177+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:34:31.156177+10:00"}
{"id":"sluice-7k2","title":"rand_float() race condition with unsafe static mut","description":"## Problem\n`rand_float()` uses unsafe static mutable SEED. This is undefined behavior if called from multiple threads, and fragile even in single-threaded code.\n\n## Location\n`crates/game/src/main.rs` lines 1585-1591\n\n## Solution\nUse `fastrand` crate or `thread_local!` with Cell. This duplicates todo 037 but records it in beads.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:31.718722+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:34:31.718722+10:00"}
{"id":"sluice-7or","title":"Test coverage at 40% - critical paths untested","description":"## Problem\nOverall test coverage is ~40%. 80% of public functions lack tests. No property-based testing for physics invariants.\n\n## Critical gaps\n- P2G/G2P shader logic\n- Pressure solver convergence\n- Sediment transport physics\n- Async readback paths\n\n## Solution\nAdd unit tests for critical paths, consider proptest for physics.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:35:00.32992+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:35:00.32992+10:00"}
{"id":"sluice-7z1","title":"NaN propagation risk in velocity normalization","description":"## Problem\nDivision by weight sum in G2P can produce NaN if weight is zero. NaN then propagates through simulation corrupting all data.\n\n## Location\n`crates/game/src/gpu/shaders/g2p_3d.wgsl`\n\n## Solution\nAdd epsilon to denominator or skip update when weight \u003c epsilon.","status":"open","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:59.214568+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:34:59.214568+10:00"}
{"id":"sluice-8y6","title":"CRITICAL: Pressure solver has fixed diagonal=6, violates SPD property","description":"## Problem\nPressure solver always divides by 6 regardless of actual neighbor count. Cells with fewer fluid/air neighbors have wrong diagonal coefficient.\n\n## Location\n`pressure_3d.wgsl` lines 168, 253\n\n## Math Error\nFor cell with only 1 fluid neighbor and 5 solid neighbors:\n- Current: sum_neighbors/6 (wrong)\n- Correct: sum_neighbors/1 (should divide by actual fluid neighbor count)\n\n## Impact\n- Loss of diagonal dominance\n- Non-symmetric system\n- Slow/non-convergent pressure solve\n- Potential numerical instability\n\n## Fix\nCount actual fluid/air neighbors, use variable diagonal.","status":"open","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:49.990286+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:41:49.990286+10:00"}
{"id":"sluice-9v0","title":"Merge DFSPH into sim crate","description":"Consolidate DFSPH into main simulation crate.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:34.267015+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:15:34.267015+10:00"}
{"id":"sluice-aru","title":"Pressure gradient zeros at riffle faces","description":"Pressure solver does not correctly handle gradients at fluid-solid boundaries.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:22.443914+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:15:22.443914+10:00"}
{"id":"sluice-b3g","title":"Water spawns at exact riffle top height","description":"Water particles spawn at y=0.44m, same height as first riffle top. Geometrically impossible for water to overflow.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:13.306122+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:15:13.306122+10:00"}
{"id":"sluice-b7y","title":"Double-free risk in ReadbackSlot::try_read()","description":"## Problem\nIf `try_read()` is called twice before new data is written, it may return the same buffer twice or trigger use-after-free if buffer is recycled.\n\n## Location\n`crates/game/src/gpu/flip_3d.rs` - ReadbackSlot implementation\n\n## Risk\nMemory corruption, undefined behavior.\n\n## Solution\nAdd consumed flag or use Option\u003cT\u003e to ensure single consumption.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:32.279762+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:34:32.279762+10:00"}
{"id":"sluice-bgp","title":"GPU settling velocity ignores particle diameter (100x error possible)","description":"## Problem\nGPU FLIP uses density-only scaling for settling velocity. Stokes law scales with d^2, giving 100x difference between 0.1mm and 1mm particles.\n\n## Location\n`g2p_3d.wgsl` lines 351-357, `g2p_3d.rs` lines 36-38\n\n## Current (wrong)\n```wgsl\nsettling_velocity = base * (density - 1.0);  // No diameter!\n```\n\n## Correct (world.rs has it right)\n```rust\nvs_stokes = g * (rho_p - rho_f) * d^2 / (18 * mu);\n```\n\n## Fix\nAdd particle diameter to GPU struct, use physical settling formula.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:51.143159+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:41:51.143159+10:00"}
{"id":"sluice-bmo","title":"Gold settling has arbitrary 2x multiplier (wrong physics)","description":"## Problem\nGold settling velocity is multiplied by 2.0 for no physical reason. This makes gold settle 22x faster than sand instead of correct 11x.\n\n## Location\n`g2p_3d.wgsl` line 354\n\n## Current\n```wgsl\nif (is_gold) {\n    vel_after_drag.y -= settling_velocity * 2.0;  // WHY 2.0?\n}\n```\n\n## Physics\nGold/sand ratio at same diameter should be:\n(19300-1000)/(2650-1000) = 11.09x\n\nCurrent gives: 18.3 * 2.0 / 1.65 = 22.2x (2x too high)\n\n## Fix\nRemove the arbitrary *2.0 multiplier.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:51.734569+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:41:51.734569+10:00"}
{"id":"sluice-bxk","title":"Zero cell size divide-by-zero in grid initialization","description":"## Problem\nIf cell_size is accidentally set to 0, multiple divisions will cause panic or infinity values.\n\n## Location\nGrid initialization in various modules\n\n## Solution\nValidate cell_size \u003e 0 at construction time with descriptive error.","status":"open","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:59.776494+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:34:59.776494+10:00"}
{"id":"sluice-dd8","title":"CFL violation - particles travel 2 cells/step","description":"CFL ~2.0, should be \u003c1.0. Fix with smaller timestep or sub-stepping.","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:35.588921+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:15:35.588921+10:00"}
{"id":"sluice-don","title":"Implement velocity extrapolation (honey-water fix)","description":"Critical fix for honey-water behavior. ~2% momentum loss per frame at fluid boundaries. Tests written in crates/sim/tests/velocity_extrapolation_tests.rs. See plans/velocity-extrapolation-implementation.md for detailed pseudocode.","status":"in_progress","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:04:17.20507+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:07:50.09932+10:00"}
{"id":"sluice-dre","title":"Open boundaries handled inconsistently across shaders","description":"## Problem\nopen_boundaries bitmask is respected in some shaders but ignored in others.\n\n## Locations\n- pressure_3d.wgsl: ignores open_boundaries for out-of-bounds (always Neumann)\n- pressure_gradient_3d.wgsl: correctly respects open_boundaries\n- fluid_cell_expand_3d.wgsl: always marks domain boundaries as SOLID regardless of open flag\n\n## Impact\nFlow cannot exit through 'open' boundaries. Pressure backs up at outlets.\n\n## Fix\nConsistently apply open_boundaries flag in all boundary-handling shaders.","status":"open","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:53.479972+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:41:53.479972+10:00"}
{"id":"sluice-hyp","title":"Fix gaps in deposited piles","description":"DEM settling produces piles with occasional holes. Polish issue.","status":"open","priority":3,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:34.920628+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:15:34.920628+10:00"}
{"id":"sluice-jaz","title":"GPU-CPU roundtrip inefficiency","description":"Grid velocities round-trip through CPU. Wastes 290KB/frame. Share buffers between P2G and G2P.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:23.119341+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:15:23.119341+10:00"}
{"id":"sluice-tem","title":"Consider SoA particle layout","description":"64-byte struct but most loops need 16 bytes. Defer until 100K+ particles.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:24.461247+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:15:24.461247+10:00"}
{"id":"sluice-thw","title":"Sediment settling velocity scaling error (~18x amplification)","description":"## Problem\nSettling velocity calculation has incorrect scaling. For gold particles (density 19300 kg/mÂ³), the current formula produces ~18x amplification versus physical reality.\n\n## Location\n`crates/sim3d/src/world.rs` - settling velocity calculation\n\n## Impact\nGold settles unrealistically fast, affecting gameplay balance.\n\n## Solution\nReview Stokes law implementation and unit conversions.","status":"open","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:58.643902+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:34:58.643902+10:00"}
{"id":"sluice-u3f","title":"Sediment particle index corruption after swap_remove","description":"## Problem\nWhen particles are removed via `swap_remove`, the index of the swapped particle changes but references in sediment mapping may not be updated.\n\n## Location\n`crates/game/src/main.rs` line 779 area - sediment particle management\n\n## Risk\nWrong particles receive sediment, physics corruption.\n\n## Solution\nUse stable indices (arena/generational) or update all references after swap.","status":"open","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:32.834357+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T18:34:32.834357+10:00"}
