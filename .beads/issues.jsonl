{"id":"sluice-003","title":"world.rs: Extract terrain.rs (excavate, collapse, add_material)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:38:09.822816+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:38:09.822816+10:00","dependencies":[{"issue_id":"sluice-003","depends_on_id":"sluice-xny","type":"blocks","created_at":"2026-01-19T23:39:56.201074+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-0jk","title":"Fix gold/gangue density unit errors in examples","description":"## Problem\nMultiple example files use relative density (19.3) instead of SI units (19300 kg/m³):\n- shaker_deck_flip.rs:70\n- settling_test.rs:45\n- shaker_deck.rs:62\n- sediment_test.rs:38\n\nAlso gangue density 2.7 vs 2650.0 in shaker_deck_flip.rs:53\n\n## Impact\nMass, force, and settling physics calculations are wrong in these examples.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:06.079456+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:13:00.88755+10:00","closed_at":"2026-01-19T23:13:00.88755+10:00","close_reason":"Fixed in commit 096cb54"}
{"id":"sluice-0tp","title":"CRITICAL: SDF and pressure cell types are decoupled","description":"## Problem\nSDF is used ONLY for particle collision. Pressure solver cell types come from particle counts and domain boundaries, NOT from SDF values.\n\n## Impact\n- Particle could be inside SDF solid but in a FLUID cell\n- Pressure solver doesn't 'see' the obstacle\n- Flow can exist where SDF says solid\n- Moving obstacles affect collision but not pressure\n\n## Location\n- `fluid_cell_expand_3d.wgsl` line 74-77: domain boundary marking\n- `flip_3d.rs`: upload_bc_and_cell_types separate from upload_sdf\n\n## Fix\nDerive cell types from SDF values, or synchronize SDF-to-cell-type on updates.","status":"closed","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:06.621573+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:12:13.040785+10:00","closed_at":"2026-01-19T19:12:13.040785+10:00","close_reason":"Fixed all P0 issues: cell type constants, pressure diagonal, CFL violation, DEM desync, SDF/cell type coupling"}
{"id":"sluice-13n","title":"[Epic] Refactor flip_3d.rs (5216 lines → 7 modules)","status":"open","priority":2,"issue_type":"feature","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:37:40.719561+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:37:40.719561+10:00"}
{"id":"sluice-2ia","title":"Particles can tunnel through thin geometry (\u003c 2 cells)","description":"## Problem\nSDF penetration correction is clamped to 2*cell_size per frame. Fast particles tunneling through thin geometry (\u003c 2 cells) won't be fully ejected.\n\n## Location\n`sdf_collision_3d.wgsl` line 168\n\n## Impact\nParticles can escape through thin walls and never return.\n\n## Fix\nRemove 2*cell_size limit or add sub-stepping for deep penetrations.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:11.100072+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:44:34.945844+10:00","closed_at":"2026-01-19T20:44:34.945844+10:00","close_reason":"Increased SDF penetration correction limit from 2x to 10x cell_size to allow particles to escape thin geometry"}
{"id":"sluice-2n5","title":"Sediment particles bypass SDF collision entirely","description":"## Problem\nIn sdf_collision_3d.wgsl, the condition `if (!is_sediment)` means sediment particles NEVER undergo SDF collision response. They rely entirely on DEM.\n\n## Location\n`sdf_collision_3d.wgsl` line 163\n\n## Impact\nIf DEM collision is disabled or misconfigured, sediment passes through solid geometry.\n\n## Fix\nEither enable SDF collision for sediment, or ensure DEM always handles sediment-solid collision.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:07.28271+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:51:35.909271+10:00","closed_at":"2026-01-19T19:51:35.909271+10:00","close_reason":"Fixed in commit 91968f9"}
{"id":"sluice-2z8","title":"Deposition suppression too aggressive in shallow water","description":"## Problem\nDeposition is overly suppressed in shallow water, preventing natural sediment accumulation even when flow velocity is low.\n\n## Location\n`crates/sim3d/src/world.rs` lines 538-549:\n```rust\nlet v_settle = settling_velocity(params.d50_sediment);\nlet deposition_suppression = if flow_speed \u003e v_settle {\n    (v_settle / flow_speed).powi(2)  // Quadratic suppression!\n} else {\n    1.0\n};\nlet v_eff = v_settle * deposition_suppression;\nlet depth_scale = water_depth.max(0.02);\nlet settling_rate = v_eff / depth_scale;\nlet settle_cap = if flow_speed \u003c 0.05 { 0.1 } else { 0.02 };\n```\n\n## Analysis\n- `v_settle` for fine sand (d50=0.1mm) ≈ 0.01 m/s\n- At flow_speed = 0.1 m/s: suppression = (0.01/0.1)² = 0.01 (99% suppressed!)\n- At flow_speed = 0.05 m/s: suppression = (0.01/0.05)² = 0.04 (96% suppressed!)\n\nThe quadratic suppression is too aggressive. Even slow flow completely prevents deposition.\n\n## Implementation Fix\n**Option A (Linear suppression):**\n```rust\nlet deposition_suppression = if flow_speed \u003e v_settle {\n    (v_settle / flow_speed).min(1.0)  // Linear, not quadratic\n} else {\n    1.0\n};\n```\n\n**Option B (Threshold-based):**\n```rust\n// Only suppress when flow is significantly faster than settling\nlet suppression_threshold = 3.0 * v_settle;\nlet deposition_suppression = if flow_speed \u003e suppression_threshold {\n    (suppression_threshold / flow_speed).powi(2)\n} else {\n    1.0\n};\n```\n\n**Option C (Rouse-based):** Use proper Rouse number formulation:\n```rust\nlet rouse = v_settle / (0.4 * shear_velocity);  // κ = 0.4\nlet deposition_efficiency = if rouse \u003e 2.5 { 1.0 }  // Bedload dominated\n    else if rouse \u003c 0.8 { 0.1 }  // Washload\n    else { (rouse - 0.8) / 1.7 };  // Suspended load transition\n```\n\n## Testing\n1. Create slow-moving shallow water over sediment bed\n2. Verify sediment deposits in eddies and slack water\n3. Gold particles should settle behind riffles\n\n## Risk\nLow-Medium - may need to rebalance erosion/deposition rates","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:35:01.475334+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T21:15:56.176193+10:00","closed_at":"2026-01-19T21:15:56.176193+10:00","close_reason":"Fixed and merged to main"}
{"id":"sluice-351","title":"Pressure solver has no convergence monitoring","description":"## Problem\nPressure solver runs exactly 40 iterations with no residual check. May under-iterate, over-iterate, or diverge silently.\n\n## Location\n`flip_3d.rs` line 4167: `self.pressure.encode(encoder, 40)`\n\n## Impact\n- Wastes GPU cycles if converged early\n- Produces garbage if system is diverging\n- 40 iterations may be insufficient for large domains\n\n## Fix\nAdd residual reduction pass, terminate early if converged, warn if diverging.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:52.888287+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:26:25.624927+10:00","closed_at":"2026-01-19T20:26:25.624927+10:00","close_reason":"Added log::trace! for pressure solver iteration count in encode() and encode_iterations_only()"}
{"id":"sluice-3c6","title":"flip_3d: Create pipeline_builder.rs (reduce 29 pipeline boilerplate)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:37:53.773897+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:37:53.773897+10:00","dependencies":[{"issue_id":"sluice-3c6","depends_on_id":"sluice-54e","type":"blocks","created_at":"2026-01-19T23:39:49.366293+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-3c8","title":"Fix 6 failing terrain_physics erosion tests","status":"open","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:21:31.890373+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:21:31.890373+10:00"}
{"id":"sluice-3o2","title":"Shear stress calculation adds two incompatible formulas","description":"## Problem\nShear stress combines gravity term and velocity term additively, but these are ALTERNATIVE formulations for the same physical quantity.\n\n## Location\n`crates/sim3d/src/world.rs` lines 520-524:\n```rust\nlet slope = bed_slope(x, z, self);\nlet grav_term = g * water_depth * slope;\nlet cf = 0.003;\nlet velocity_term = cf * (vx * vx + vz * vz);\nlet shear_stress = params.rho_water * (grav_term + velocity_term);  // WRONG!\n```\n\n## Physics Background\nTwo ways to compute bed shear stress:\n1. **Slope-based (steady uniform flow):** τ = ρ × g × h × S\n   - Valid when: flow is uniform, depth-slope product gives friction\n2. **Velocity-based (general flow):** τ = ρ × Cf × v²\n   - Valid when: flow is non-uniform, turbulent friction dominates\n\nThese are NOT additive - they're alternative derivations of the same force.\n\n## Implementation Fix\nUse velocity-based only (more accurate for non-uniform flow):\n```rust\n// Lines 520-524: Replace with:\nlet cf = 0.003;  // Friction coefficient (or use Manning-derived)\nlet v_sq = vx * vx + vz * vz;\nlet shear_stress = params.rho_water * cf * v_sq;\n```\n\n**Also fix duplicate at lines 850-875** (`shear_velocity()` method):\n```rust\npub fn shear_velocity(\u0026self, x: usize, z: usize) -\u003e f32 {\n    let cf = 0.003;\n    let v_sq = /* get velocity squared */;\n    (cf * v_sq).sqrt()  // u* = sqrt(Cf) * v\n}\n```\n\n## Testing\n1. Verify Shields stress values are reasonable (0.01-0.1 range for typical flows)\n2. Erosion should occur at expected velocities (~0.3-0.5 m/s for sand)\n\n## Risk\nMedium - affects all erosion calculations. May need to recalibrate erosion rates.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:52.322217+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T21:15:56.174808+10:00","closed_at":"2026-01-19T21:15:56.174808+10:00","close_reason":"Fixed and merged to main"}
{"id":"sluice-3oh","title":"flip_3d: Extract diagnostics.rs (debug utilities)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:37:54.535522+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:37:54.535522+10:00"}
{"id":"sluice-3on","title":"Shader validation tests (Naga)","description":"## Goal\nUse Naga to validate and test WGSL shaders beyond just compilation.\n\n## Tests to add\n1. **Parse validation** - All shaders parse without errors\n2. **Type checking** - Bindings match Rust-side buffer layouts\n3. **Compute shader unit tests** - Run shaders on known inputs, verify outputs:\n   - P2G scatter: single particle → expected grid contribution\n   - G2P gather: known grid → expected particle velocity\n   - Pressure Jacobi: one iteration on simple case\n   - Prefix sum: verify correct output for edge cases\n\n## Approach\n- Use wgpu in test mode with `Backends::empty()` or software renderer\n- Create minimal test buffers, dispatch compute, read back results\n- Compare against CPU reference implementation\n\n## Files to test\n- p2g_scatter_3d.wgsl\n- g2p_3d.wgsl  \n- pressure_jacobi_3d.wgsl\n- particle_sort_*.wgsl\n- sph_dfsph.wgsl","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T21:55:02.802091+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:05:09.520008+10:00","closed_at":"2026-01-19T22:05:09.520008+10:00","close_reason":"5 shader validation tests implemented","dependencies":[{"issue_id":"sluice-3on","depends_on_id":"sluice-7or","type":"blocks","created_at":"2026-01-19T21:56:27.685516+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-42e","title":"Fixed-point atomic overflow risk in P2G scatter","description":"## Problem\nIn `p2g_scatter_3d.wgsl`, fixed-point atomics use SCALE=1,000,000 with i32 max ~2.1e9. With high particle counts (100k+) accumulating in single cells, overflow is possible.\n\n## Location\n`crates/game/src/gpu/shaders/p2g_scatter_3d.wgsl`\n\n## Risk\nSilent data corruption, unstable simulation.\n\n## Solution\nUse i64 atomics or reduce SCALE factor with saturation checks.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:30.61681+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:51:35.914464+10:00","closed_at":"2026-01-19T19:51:35.914464+10:00","close_reason":"Fixed in commit 91968f9"}
{"id":"sluice-4t4","title":"CRITICAL: Cell type constant mismatch between multigrid and main shaders","description":"## Problem\nMultigrid pressure solver shaders use CELL_SOLID=0, but main 3D shaders use CELL_SOLID=2. This causes completely wrong boundary conditions.\n\n## Locations\n- mg_smooth.wgsl, mg_residual.wgsl, mg_prolongate.wgsl, mg_restrict.wgsl, pcg_ops.wgsl: CELL_SOLID=0\n- All main shaders (p2g, g2p, pressure, etc.): CELL_SOLID=2\n\n## Impact\n- AIR cells (0) treated as SOLID in multigrid\n- SOLID cells (2) treated as AIR\n- Completely wrong pressure solve with multigrid preconditioner\n\n## Fix\nUnify all shaders to use CELL_SOLID=2 (or 0, but consistently).","status":"closed","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:49.366491+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:12:13.03388+10:00","closed_at":"2026-01-19T19:12:13.03388+10:00","close_reason":"Fixed all P0 issues: cell type constants, pressure diagonal, CFL violation, DEM desync, SDF/cell type coupling"}
{"id":"sluice-4zy","title":"Parallel array desync between sediment_flip_indices and dem.clumps","description":"## Problem\nWhen multiple sediment particles are deleted in one frame, swap_remove on parallel arrays (sediment_flip_indices and dem.clumps) can desync them.\n\n## Location\n`main.rs` lines 744-791\n\n## Mechanism\n1. Delete particle at index 100, sediment_pos=5\n2. clumps.swap_remove(5) - clump 8 moves to 5\n3. sediment_flip_indices.swap_remove(5) - index 8 moves to 5\n4. Delete particle at index 50, sediment_pos=3\n5. clumps.swap_remove(3) - clump 7 moves to 3\n6. BUT clump 7 was ALREADY remapped in step 2!\n\n## Impact\nWrong DEM clumps receive FLIP velocities. Sediment physics corruption.\n\n## Fix\nUse generational indices or store DEM clump index directly in FLIP particle.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:50.572739+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:45:21.063614+10:00","closed_at":"2026-01-19T19:45:21.063614+10:00","close_reason":"Analyzed: back-to-front deletion with parallel swap_remove maintains array correspondence correctly"}
{"id":"sluice-524","title":"Encapsulate Grid3D and Particles3D public fields","description":"## Problem\nGrid3D exposes pub u/v/w/pressure/divergence/cell_type/sdf Vec fields directly.\nParticles3D exposes pub list Vec field.\n\nmain.rs directly accesses: sim.particles.list, sim.grid.sdf\n\n## Fix\nReplace pub fields with getter/setter methods:\n- fn u(\u0026self) -\u003e \u0026[f32]\n- fn iter(\u0026self) -\u003e impl Iterator\n- fn remove(\u0026mut self, idx: usize)\n\n## Impact\nBreaks encapsulation, prevents adding invariant validation.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:28.633965+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:58:28.633965+10:00"}
{"id":"sluice-54e","title":"flip_3d: Extract params.rs (15 GPU uniform structs)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:37:52.265036+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:37:52.265036+10:00"}
{"id":"sluice-59h","title":"Replace linked-list spatial hash","description":"Use prefix-sum dense array instead of linked-list. 15-20% speedup expected.","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:23.790013+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T21:42:41.654487+10:00","closed_at":"2026-01-19T21:42:41.654487+10:00","close_reason":"Replaced HashMap-based spatial hash with counting sort + prefix sum dense array. Better cache locality for neighbor lookups. Tests pass: test_dem_spatial_hash_correctness, test_spatial_hash_cell_assignment."}
{"id":"sluice-5rv","title":"Integration test scenarios","description":"## Goal\nEnd-to-end tests for complete simulation scenarios.\n\n## Benchmark Scenarios\n- **Dam break** - Compare against analytical/published results\n- **Hydrostatic column** - Pressure profile matches theory\n- **Sloshing tank** - Period matches expected frequency\n- **Falling drop** - Splash pattern reasonable\n\n## Game-Specific Scenarios  \n- **Sluice flow** - Water flows downhill, settles correctly\n- **Sediment separation** - Heavy particles settle, light float\n- **Riffle capture** - Gold captured behind riffles\n- **Washplant throughput** - Particles transfer between stages\n\n## Performance Baselines\n- Track FPS/step time for standard scenarios\n- Alert on significant regression (\u003e10% slower)\n- Record particle count scaling curves\n\n## Approach\n- Run each scenario for fixed duration\n- Check end-state metrics (positions, velocities, counts)\n- Compare against recorded baseline values\n- Allow small tolerance for floating-point variance","status":"closed","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T21:55:57.038837+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:05:10.144868+10:00","closed_at":"2026-01-19T22:05:10.144868+10:00","close_reason":"3 integration scenario tests implemented","dependencies":[{"issue_id":"sluice-5rv","depends_on_id":"sluice-7or","type":"blocks","created_at":"2026-01-19T21:56:28.634086+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-6cp","title":"Missing architecture documentation","description":"## Problem\nNo high-level architecture overview. New developers cannot understand system structure. Missing documentation for:\n- GPU pipeline stages\n- Data flow between CPU/GPU\n- Shader organization\n- Sediment physics model\n\n## Solution\nCreate docs/ARCHITECTURE.md with diagrams and explanations.","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:35:00.907694+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:14:29.18337+10:00","closed_at":"2026-01-19T22:14:29.18337+10:00","close_reason":"Created 4 targeted documentation files: SHADERS.md (64 shaders categorized), CPU_GPU_DATA_FLOW.md (buffer transfer timeline), SEDIMENT_PHYSICS.md (Drucker-Prager, entrainment model), CRATE_STRUCTURE.md (game vs sim3d)"}
{"id":"sluice-6n0","title":"Model buoyancy for sediment particles","description":"## Problem\nSediment settling uses terminal velocity but ignores buoyancy-induced pressure forces.\n\nPhysical formula:\nF_net = (ρ_sediment - ρ_water) * V * g\n\nCurrent code only applies terminal settling velocity.\n\n## Impact\nSettling behavior approximately correct, but density-driven pressure gradients not captured.","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:59.798911+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:58:59.798911+10:00"}
{"id":"sluice-78k","title":"Delete backup shader file","description":"## Problem\ndensity_correct_3d_backup.wgsl exists as a dead backup file.\n\n## Fix\nDelete crates/game/src/gpu/shaders/density_correct_3d_backup.wgsl\n\n## Impact\nReduces confusion about which shader is active.","status":"closed","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:58.180496+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:32:19.499248+10:00","closed_at":"2026-01-19T23:32:19.499248+10:00","close_reason":"Closed"}
{"id":"sluice-7al","title":"GPU/CPU state divergence in async readback","description":"## Problem\nAsync GPU readback with double-buffered slots can leave CPU state stale for 2+ frames. If GPU fails to signal completion, CPU may read garbage or outdated data.\n\n## Location\n`crates/game/src/gpu/flip_3d.rs` - ReadbackSlot logic\n\n## Risk\nCorrupted particle data, physics glitches.\n\n## Solution\nAdd fence synchronization or timeout detection with graceful degradation.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:31.156177+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:46:25.089031+10:00","closed_at":"2026-01-19T19:46:25.089031+10:00","close_reason":"Double-buffered slots handle normal async operation; true device stalls are covered by sluice-7sr"}
{"id":"sluice-7k2","title":"rand_float() race condition with unsafe static mut","description":"## Problem\n`rand_float()` uses unsafe static mutable SEED. This is undefined behavior if called from multiple threads, and fragile even in single-threaded code.\n\n## Location\n`crates/game/src/main.rs` lines 1585-1591\n\n## Solution\nUse `fastrand` crate or `thread_local!` with Cell. This duplicates todo 037 but records it in beads.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:31.718722+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:51:35.912548+10:00","closed_at":"2026-01-19T19:51:35.912548+10:00","close_reason":"Fixed in commit 91968f9"}
{"id":"sluice-7or","title":"Test coverage at 40% - critical paths untested","description":"## Problem\nOverall test coverage is ~40%. 80% of public functions lack tests. No property-based testing for physics invariants.\n\n## Critical gaps\n- P2G/G2P shader logic\n- Pressure solver convergence\n- Sediment transport physics\n- Async readback paths\n\n## Solution\nAdd unit tests for critical paths, consider proptest for physics.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:35:00.32992+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:05:16.59955+10:00","closed_at":"2026-01-19T22:05:16.59955+10:00","close_reason":"All 6 sub-issues implemented: 57 new tests total (shader: 5, physics: 24, logic: 17, visual: 3, proptest: 5, integration: 3)"}
{"id":"sluice-7sr","title":"No GPU device lost handling - will panic","description":"## Problem\nNo device lost callbacks. When GPU device is lost (power event, driver crash, timeout), all operations fail and current unwrap() calls cascade into panics.\n\n## Pattern\nEvery buffer map uses:\n```rust\nrx.recv().unwrap().unwrap();  // Double unwrap - channel AND map result\n```\n\n## Affected Files\nflip_3d.rs, g2p_3d.rs, p2g_3d.rs, sph_3d.rs, mgpcg.rs, heightfield.rs\n\n## Fix\nAdd device lost callback, wrap buffer maps in Result, propagate errors.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:08.537294+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:55:31.245693+10:00","closed_at":"2026-01-19T19:55:31.245693+10:00","close_reason":"Fixed: Added await_buffer_map helper, device lost detection, graceful error handling in flip_3d.rs and g2p_3d.rs"}
{"id":"sluice-7z1","title":"NaN propagation risk in velocity normalization","description":"## Problem\nDivision by weight sum in G2P can produce NaN if weight is zero. NaN then propagates through simulation corrupting all data.\n\n## Location\n`crates/game/src/gpu/shaders/g2p_3d.wgsl`\n\n## Solution\nAdd epsilon to denominator or skip update when weight \u003c epsilon.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:59.214568+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:26:24.8748+10:00","closed_at":"2026-01-19T20:26:24.8748+10:00","close_reason":"Added WEIGHT_EPSILON (1e-10) threshold to G2P shader weight_sum checks to prevent NaN from near-zero division"}
{"id":"sluice-8an","title":"Property-based tests (proptest)","description":"## Goal\nUse proptest to verify physics invariants hold for arbitrary inputs.\n\n## Conservation Laws\n- **Mass**: particle count constant (no spawns/despawns)\n- **Momentum**: total momentum conserved (no external forces)\n- **Energy**: kinetic energy bounded (no explosions)\n- **Volume**: incompressibility maintained (divergence near zero)\n\n## Numerical Stability\n- No NaN/Inf in positions, velocities, pressures\n- Positions stay within bounds\n- Velocities bounded by CFL condition\n- Pressures non-negative (or physically reasonable negative)\n\n## Invariant Properties\n- Symmetry: mirrored initial conditions → mirrored results\n- Determinism: same input → same output\n- Continuity: small input change → small output change\n\n## Setup\n- Add proptest to dev-dependencies\n- Create generators for valid particle configurations\n- Run short simulations (10-50 steps) per test case\n- Use proptest shrinking to find minimal failing case","status":"closed","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T21:55:46.022343+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:05:10.018628+10:00","closed_at":"2026-01-19T22:05:10.018628+10:00","close_reason":"5 proptest tests implemented","dependencies":[{"issue_id":"sluice-8an","depends_on_id":"sluice-7or","type":"blocks","created_at":"2026-01-19T21:56:28.442145+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-8jt","title":"flip_3d: Extract initialization.rs (2582-line new() → builders)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:37:55.290616+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:37:55.290616+10:00","dependencies":[{"issue_id":"sluice-8jt","depends_on_id":"sluice-3c6","type":"blocks","created_at":"2026-01-19T23:39:49.568237+10:00","created_by":"doctorspritz"},{"issue_id":"sluice-8jt","depends_on_id":"sluice-54e","type":"blocks","created_at":"2026-01-19T23:39:49.775199+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-8ml","title":"DEM velocity sync overwrites FLIP drag and settling","description":"## Problem\nG2P shader applies drag and settling to sediment. Then DEM collision_response_only replaces velocity entirely on collision. The physics are applied twice or partially overwritten.\n\n## Location\n- `g2p_3d.wgsl` lines 339-359: applies drag, settling\n- `clump.rs` line 497: velocity = new_v_normal + new_v_tangent (complete replacement)\n\n## Impact\nInconsistent sediment physics depending on collision state.\n\n## Fix\nHave DEM only apply velocity CHANGES from collision, not replace entirely.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:07.900789+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:51:35.907398+10:00","closed_at":"2026-01-19T19:51:35.907398+10:00","close_reason":"Fixed in commit 91968f9"}
{"id":"sluice-8t5","title":"Batch GPU command encoders to reduce overhead","description":"## Problem\n131 encoder.copy_buffer_to_buffer and queue.write_buffer calls in run_gpu_passes.\nEach create_command_encoder → submit cycle causes GPU pipeline stalls.\n\n## Current\n~20+ separate encoders for: P2G, sediment, BC, cell type, gravity, pressure...\n\n## Fix\nBatch into 8-10 encoders:\n[P2G + Sediment] [BC + Copy] [Cell Type×5] [Gravity + Pressure]\n\n## Impact\nEstimated 3-5% FPS improvement at 500k+ particles.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:56.555597+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:58:56.555597+10:00"}
{"id":"sluice-8y6","title":"CRITICAL: Pressure solver has fixed diagonal=6, violates SPD property","description":"## Problem\nPressure solver always divides by 6 regardless of actual neighbor count. Cells with fewer fluid/air neighbors have wrong diagonal coefficient.\n\n## Location\n`pressure_3d.wgsl` lines 168, 253\n\n## Math Error\nFor cell with only 1 fluid neighbor and 5 solid neighbors:\n- Current: sum_neighbors/6 (wrong)\n- Correct: sum_neighbors/1 (should divide by actual fluid neighbor count)\n\n## Impact\n- Loss of diagonal dominance\n- Non-symmetric system\n- Slow/non-convergent pressure solve\n- Potential numerical instability\n\n## Fix\nCount actual fluid/air neighbors, use variable diagonal.","status":"closed","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:49.990286+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:12:13.036262+10:00","closed_at":"2026-01-19T19:12:13.036262+10:00","close_reason":"Fixed all P0 issues: cell type constants, pressure diagonal, CFL violation, DEM desync, SDF/cell type coupling"}
{"id":"sluice-9de","title":"Fix flaky test_outlet_removal test","description":"Test in crates/sim3d/tests/advection_test.rs:207 fails intermittently. Particle spawned near right edge with rightward velocity should exit through outlet but doesn't. May be related to boundary conditions or outlet detection logic.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:13:08.831573+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:21:31.205891+10:00","closed_at":"2026-01-19T23:21:31.205891+10:00","close_reason":"Fixed in commit 3b207eb - use direct advection instead of full FLIP"}
{"id":"sluice-9v0","title":"Merge DFSPH into sim crate","description":"Consolidate DFSPH into main simulation crate.","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:34.267015+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:31:11.287377+10:00","closed_at":"2026-01-19T22:31:11.287377+10:00","close_reason":"DFSPH solver is broken/unstable - FLIP works well, not pursuing SPH approach"}
{"id":"sluice-a08","title":"world.rs: Extract fine_region.rs (LOD management)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:38:12.867569+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:38:12.867569+10:00","dependencies":[{"issue_id":"sluice-a08","depends_on_id":"sluice-f7k","type":"blocks","created_at":"2026-01-19T23:39:57.252261+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-a3h","title":"Physics unit tests","description":"## Goal\nUnit test core physics calculations independent of GPU.\n\n## P2G/G2P Transfer\n- Quadratic B-spline weights sum to 1.0\n- Single particle at cell center → correct grid contribution\n- Affine velocity matrix preserves angular momentum\n- FLIP vs PIC blending produces expected result\n\n## Pressure Solver\n- Jacobi iteration reduces residual\n- Pressure gradient produces divergence-free velocity\n- Boundary conditions (solid, free surface) applied correctly\n- Convergence on simple test cases (uniform pressure, hydrostatic)\n\n## Sediment Transport  \n- Density-based buoyancy direction correct\n- Settling velocity matches Stokes law\n- Erosion/deposition thresholds respected\n- Mass conservation during transport\n\n## Approach\n- Extract pure math functions where possible\n- Test with known analytical solutions\n- Verify against published benchmarks (dam break, hydrostatic)","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T21:55:24.697488+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:05:09.645013+10:00","closed_at":"2026-01-19T22:05:09.645013+10:00","close_reason":"24 physics unit tests implemented","dependencies":[{"issue_id":"sluice-a3h","depends_on_id":"sluice-7or","type":"blocks","created_at":"2026-01-19T21:56:28.063556+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-ai2","title":"Logic unit tests","description":"## Goal\nUnit test non-physics logic: data structures, algorithms, GPU orchestration.\n\n## Spatial Hash / Particle Sort\n- Cell assignment correct for edge positions\n- Prefix sum produces valid offsets\n- Sorted order matches cell keys\n- Empty cells handled correctly\n- Boundary particles assigned to valid cells\n\n## Buffer Management\n- Resize preserves existing data\n- Double-buffering swaps correctly\n- Staging buffer roundtrip preserves values\n- Capacity growth doesn't lose particles\n\n## GPU Orchestration\n- Dispatch dimensions correct for particle/grid counts\n- Bind groups reference correct buffers after swap\n- Command encoder ordering (P2G before pressure before G2P)\n\n## Async Readback\n- Data arrives complete (no partial reads)\n- Multiple concurrent readbacks don't race\n- Timeout handling for stalled GPU","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T21:55:34.968255+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:05:09.770184+10:00","closed_at":"2026-01-19T22:05:09.770184+10:00","close_reason":"17 logic unit tests implemented","dependencies":[{"issue_id":"sluice-ai2","depends_on_id":"sluice-7or","type":"blocks","created_at":"2026-01-19T21:56:28.250685+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-aoi","title":"DEM position correction uses 1.01x factor causing oscillation","description":"## Problem\nWhen pushing particles out of solids, DEM adds 1% extra:\n`clump.position += normal * penetration * 1.01`\n\nThis overshoots, and when FLIP re-integrates, particle moves back, causing oscillation.\n\n## Location\n`crates/sim3d/src/clump.rs` line 480\n\n## Root Cause\nThe 1.01 multiplier was added to \"avoid re-penetration\" but it causes the opposite problem: particles overshoot, then get pulled back by FLIP integration, creating a feedback loop.\n\n## Implementation Fix\n**Option A (Simple):** Remove the 1.01 factor entirely:\n```rust\n// Line 480: Change from:\nclump.position += normal * penetration * 1.01;\n// To:\nclump.position += normal * penetration;\n```\n\n**Option B (Better):** Use a tiny epsilon offset based on velocity/dt:\n```rust\nlet epsilon = 1e-4 * self.cell_size; // Sub-cell epsilon\nclump.position += normal * (penetration + epsilon);\n```\n\n## Testing\n1. Run DEM settling test - particles should come to rest without visible jitter\n2. Check `test_dem_water_coupling.rs` for no_overshoot assertion\n\n## Risk\nLow - localized change in collision response","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:10.470053+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T21:15:56.169606+10:00","closed_at":"2026-01-19T21:15:56.169606+10:00","close_reason":"Fixed and merged to main"}
{"id":"sluice-aru","title":"Pressure gradient zeros at riffle faces","description":"Pressure solver does not correctly handle gradients at fluid-solid boundaries.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:22.443914+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:42:33.763413+10:00","closed_at":"2026-01-19T19:42:33.763413+10:00","close_reason":"Fixed: Implemented directional no-penetration - only zeros velocity INTO solid, preserves flow AWAY from solid"}
{"id":"sluice-b3g","title":"Water spawns at exact riffle top height","description":"Water particles spawn at y=0.44m, same height as first riffle top. Geometrically impossible for water to overflow.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:13.306122+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:37:12.520543+10:00","closed_at":"2026-01-19T19:37:12.520543+10:00","close_reason":"Already fixed in Gate 2 of fix-riffle-flow.md - spawn height now 0.520m (above riffle top at 0.440m)"}
{"id":"sluice-b6s","title":"Replace unwrap() calls with expect() or proper error handling","description":"## Problem\n476 unwrap() calls across 63 files, many without context.\n\n## High-risk patterns\n- Chained unwraps: rx.recv().unwrap().unwrap() (10+ instances)\n- Equipment geometry: 16 repeated buffer unwraps\n- Main app startup: window creation unwrap\n\n## Fix\nReplace with .expect(\"context message\") or proper Result propagation.\n\n## Impact\nSilent panics with no debugging context.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:55.751251+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:58:55.751251+10:00"}
{"id":"sluice-b7y","title":"Double-free risk in ReadbackSlot::try_read()","description":"## Problem\nIf `try_read()` is called twice before new data is written, it may return the same buffer twice or trigger use-after-free if buffer is recycled.\n\n## Location\n`crates/game/src/gpu/flip_3d.rs` - ReadbackSlot implementation\n\n## Risk\nMemory corruption, undefined behavior.\n\n## Solution\nAdd consumed flag or use Option\u003cT\u003e to ensure single consumption.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:32.279762+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:46:24.372186+10:00","closed_at":"2026-01-19T19:46:24.372186+10:00","close_reason":"Already protected: pending flag guards against double-read, returns None if try_read called again before new data written"}
{"id":"sluice-bgp","title":"GPU settling velocity ignores particle diameter (100x error possible)","description":"## Problem\nGPU FLIP uses density-only scaling for settling velocity. Stokes law scales with d^2, giving 100x difference between 0.1mm and 1mm particles.\n\n## Location\n`g2p_3d.wgsl` lines 351-357, `g2p_3d.rs` lines 36-38\n\n## Current (wrong)\n```wgsl\nsettling_velocity = base * (density - 1.0);  // No diameter!\n```\n\n## Correct (world.rs has it right)\n```rust\nvs_stokes = g * (rho_p - rho_f) * d^2 / (18 * mu);\n```\n\n## Fix\nAdd particle diameter to GPU struct, use physical settling formula.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:51.143159+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:39:56.702088+10:00","closed_at":"2026-01-19T19:39:56.702088+10:00","close_reason":"Fixed: Now uses pre-computed Stokes settling velocities via select() instead of incorrect density scaling"}
{"id":"sluice-bko","title":"Extract magic numbers to named constants","description":"## Problem\n30+ magic numbers scattered in terrain_generator.rs and world.rs:\n- flip_ratio: 0.97 (no explanation for 97%)\n- angle_of_repose: 35.0, 38.0, 32.0, 45.0 degrees\n- hardness values: 0.5, 1.0, 2.0, 5.0\n- Terrain generator scales: 0.35, 0.5, 15.0, 25.0, etc.\n\n## Fix\nCreate named constants with documentation explaining physical meaning.","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:58.987794+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:58:58.987794+10:00"}
{"id":"sluice-bmo","title":"Gold settling has arbitrary 2x multiplier (wrong physics)","description":"## Problem\nGold settling velocity is multiplied by 2.0 for no physical reason. This makes gold settle 22x faster than sand instead of correct 11x.\n\n## Location\n`g2p_3d.wgsl` line 354\n\n## Current\n```wgsl\nif (is_gold) {\n    vel_after_drag.y -= settling_velocity * 2.0;  // WHY 2.0?\n}\n```\n\n## Physics\nGold/sand ratio at same diameter should be:\n(19300-1000)/(2650-1000) = 11.09x\n\nCurrent gives: 18.3 * 2.0 / 1.65 = 22.2x (2x too high)\n\n## Fix\nRemove the arbitrary *2.0 multiplier.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:51.734569+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:51:35.910907+10:00","closed_at":"2026-01-19T19:51:35.910907+10:00","close_reason":"Fixed in commit 91968f9"}
{"id":"sluice-bxk","title":"Zero cell size divide-by-zero in grid initialization","description":"## Problem\nIf cell_size is accidentally set to 0, multiple divisions will cause panic or infinity values.\n\n## Location\nGrid initialization in various modules\n\n## Solution\nValidate cell_size \u003e 0 at construction time with descriptive error.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:59.776494+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:26:24.143429+10:00","closed_at":"2026-01-19T20:26:24.143429+10:00","close_reason":"Added cell_size \u003e 0 assertions in Grid3D::new, FlipSimulation3D::new, and GpuFlip3D::new with 4 new panic tests"}
{"id":"sluice-clw","title":"world.rs: Extract geometry.rs (mesh generation)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:38:08.2452+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:38:08.2452+10:00"}
{"id":"sluice-dd8","title":"CFL violation - particles travel 2 cells/step","description":"CFL ~2.0, should be \u003c1.0. Fix with smaller timestep or sub-stepping.","status":"closed","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:35.588921+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:30:20.647002+10:00","closed_at":"2026-01-19T22:30:20.647002+10:00","close_reason":"Increased SUBSTEPS from 2 to 4, doubling CFL safety margin (max safe velocity now 2.5 m/s)"}
{"id":"sluice-don","title":"Implement velocity extrapolation (honey-water fix)","description":"Critical fix for honey-water behavior. ~2% momentum loss per frame at fluid boundaries. Tests written in crates/sim/tests/velocity_extrapolation_tests.rs. See plans/velocity-extrapolation-implementation.md for detailed pseudocode.","status":"closed","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:04:17.20507+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:50:56.305393+10:00","closed_at":"2026-01-19T20:50:56.305393+10:00","close_reason":"Already implemented: velocity_extrapolate_3d.wgsl shader exists, flip_3d.rs runs 4 extrapolation passes"}
{"id":"sluice-dre","title":"Open boundaries handled inconsistently across shaders","description":"## Problem\n`open_boundaries` bitmask is respected in some shaders but ignored in others, preventing flow through open boundaries.\n\n## Locations\n| Shader | Status | Line | Issue |\n|--------|--------|------|-------|\n| `pressure_gradient_3d.wgsl` | ✅ Correct | 61-95 | Uses `get_cell_type()` with open_boundaries |\n| `gravity_3d.wgsl` | ✅ Correct | 38-75 | Uses `get_cell_type()` with open_boundaries |\n| `enforce_bc_3d.wgsl` | ✅ Correct | 68-194 | Checks open_boundaries for each axis |\n| `sdf_collision_3d.wgsl` | ✅ Correct | 37-58 | `is_cell_solid()` respects open_boundaries |\n| `fluid_cell_expand_3d.wgsl` | ❌ **BUG** | 74-76 | **Always marks domain boundary as SOLID** |\n\n## Root Cause\n`fluid_cell_expand_3d.wgsl` line 74-76:\n```wgsl\nif (is_domain_boundary(i, j, k)) {\n    cell_type[idx] = CELL_SOLID;  // Ignores open_boundaries!\n    return;\n}\n```\n\n## Implementation Fix\nUpdate `fluid_cell_expand_3d.wgsl` to check `open_boundaries`:\n```wgsl\nfn is_domain_boundary_solid(i: i32, j: i32, k: i32) -\u003e bool {\n    let open_neg_x = (params.open_boundaries \u0026 1u) != 0u;\n    let open_pos_x = (params.open_boundaries \u0026 2u) != 0u;\n    // ... etc for all 6 faces\n    \n    if (i \u003c 0) { return !open_neg_x; }\n    if (i \u003e= i32(params.grid_width)) { return !open_pos_x; }\n    // ... etc\n    return false;\n}\n\n// Then in main:\nif (is_domain_boundary_solid(i, j, k)) {\n    cell_type[idx] = CELL_SOLID;\n    return;\n}\n```\n\n## Testing\n1. Set `open_boundaries = 2` (+X open), spawn water, verify it exits +X boundary\n2. Check pressure doesn't build up at open boundaries\n\n## Risk\nMedium - affects all boundary behavior. Test with channel flow example.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:41:53.479972+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T21:15:56.173191+10:00","closed_at":"2026-01-19T21:15:56.173191+10:00","close_reason":"Fixed and merged to main"}
{"id":"sluice-e8w","title":"Fix inertia tensor outer product error","description":"## Problem\nIn clump.rs:1416, the outer product computation for inertia tensor is incorrect.\n\n## Current code\n```rust\nlet outer = Mat3::from_cols(*r * r.x, *r * r.y, *r * r.z);\n```\n\n## Correct code\n```rust\nlet outer = Mat3::from_cols(\n    Vec3::new(r.x * r.x, r.x * r.y, r.x * r.z),\n    Vec3::new(r.y * r.x, r.y * r.y, r.y * r.z),\n    Vec3::new(r.z * r.x, r.z * r.y, r.z * r.z),\n);\n```\n\n## Impact\nInertia tensor is underestimated, causing clumps to rotate faster than physically correct.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:04.455366+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:13:00.883002+10:00","closed_at":"2026-01-19T23:13:00.883002+10:00","close_reason":"Fixed in commit 096cb54"}
{"id":"sluice-f7k","title":"world.rs: Extract water_flow.rs (SWE solver, 269-line function)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:38:10.564707+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:38:10.564707+10:00","dependencies":[{"issue_id":"sluice-f7k","depends_on_id":"sluice-xny","type":"blocks","created_at":"2026-01-19T23:39:56.408292+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-g2a","title":"Standardize gravity constant usage across codebase","description":"## Problem\nMultiple files define local gravity constants instead of using constants::GRAVITY:\n- -9.8 in 10+ example files (off by 0.01 from -9.81)\n- Local GRAVITY, SIM_GRAVITY, FLIP_GRAVITY constants\n\n## Fix\nReplace all with constants::GRAVITY (-9.81)\n\n## Files affected\n- physics_validation.rs, shaker_deck_flip.rs, settling_test.rs\n- test_level_0.rs, test_level_2.rs, chained_grids.rs\n- chained_grids_visual.rs, shaker_deck.rs, sediment_test.rs","status":"closed","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:57.34862+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:32:19.551109+10:00","closed_at":"2026-01-19T23:32:19.551109+10:00","close_reason":"Closed"}
{"id":"sluice-gbd","title":"Erosion tests fail due to max_erosion_per_step cap dominating hardness","description":"Two erosion tests in sim3d are failing:\n\n1. `test_gravel_erosion_with_hardness` (world.rs:3021)\n2. `test_erosion_layer_order` (world.rs:3172)\n\n**Root Cause Analysis:**\n\nThe `update_erosion` function has a `max_erosion_per_step = 0.00001 * dt` cap (line 2058) that limits erosion to 0.000001 meters per step when dt=0.1.\n\nThis cap is hit by both soft (sediment, hardness=0.5) and hard (gravel, hardness=2.0) materials, making them erode at identical rates despite different hardness values.\n\nThe Shields-based erosion rate calculation correctly accounts for hardness:\n```\nerosion_rate = 0.0001 * excess / hardness\n```\n\nBut the rate is then capped:\n```\nerode_height = (erosion_rate * dt).min(*thickness).min(max_erosion_per_step)\n```\n\n**Test Failures:**\n- `test_gravel_erosion_with_hardness`: Both sediment and gravel hit the cap, so sediment doesn't erode more than gravel\n- `test_erosion_layer_order`: After 20 iterations, only 0.00000223m eroded vs expected \u003e0.00001m\n\n**Potential Fixes:**\n1. Make max_erosion_per_step scale inversely with hardness\n2. Increase the base erosion cap constant\n3. Remove the cap entirely and rely on physical Shields-based limiting\n\n**Files:**\n- crates/sim3d/src/world.rs:2040-2230 (update_erosion function)\n- crates/sim3d/src/world.rs:3021-3071 (test_gravel_erosion_with_hardness)\n- crates/sim3d/src/world.rs:3172-3235 (test_erosion_layer_order)","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T20:11:54.12688+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:16:34.089633+10:00","closed_at":"2026-01-19T20:16:34.089633+10:00","close_reason":"Fixed: Increased max_erosion_per_step from 0.00001 to 0.001 so physics-based rates dominate; Added missing struct fields and constant to detail_zone.rs"}
{"id":"sluice-h8u","title":"Add integration tests for P2G/G2P momentum conservation","description":"## Problem\nTransfer functions (P2G/G2P) only have 2 basic tests. No tests verify:\n- Total momentum before/after full cycle\n- APIC angular momentum preservation\n- Divergence-free property after pressure solve\n\n## Tests needed\n1. full_simulation_step_conserves_momentum\n2. p2g_g2p_cycle_preserves_velocity_scale\n3. pressure_solver_achieves_divergence_free_flow\n\n## Impact\nCore FLIP physics untested - bugs could go undetected.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:27.752285+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:58:27.752285+10:00"}
{"id":"sluice-hyp","title":"Fix gaps in deposited piles","description":"## Problem\nDEM settling produces piles with occasional holes/gaps. This is a polish issue affecting visual quality.\n\n## Likely Causes\n1. **Particle locking:** Particles get stuck in metastable configurations\n2. **Insufficient settling iterations:** Particles don't have time to find stable positions\n3. **Contact detection gaps:** Narrow gaps between particles not detected\n4. **Timestep too large:** Particles jump over stable positions\n\n## Locations to Investigate\n- `crates/sim3d/src/clump.rs`:\n  - `step_dem_internal()` (line 537) - main DEM loop\n  - `resolve_dem_penetrations()` (line 1090) - penetration resolution\n  - Contact detection in `step_dem_internal()`\n\n## Potential Fixes\n**A. Increase settling iterations:**\n```rust\n// In resolve_dem_penetrations, increase from 2 to 4-6\nself.resolve_dem_penetrations(6);\n```\n\n**B. Add jitter to break metastable states:**\n```rust\n// Small random perturbation when velocity is very low\nif vel.length_squared() \u003c 1e-6 {\n    clump.position += Vec3::new(\n        rng.gen_range(-0.001..0.001),\n        rng.gen_range(-0.001..0.001),\n        rng.gen_range(-0.001..0.001),\n    ) * cell_size;\n}\n```\n\n**C. Smaller DEM timestep:**\n```rust\n// Use smaller sub-dt for DEM when settling\nlet dem_substeps = if settling_phase { 4 } else { 1 };\n```\n\n**D. Post-process gap filling:**\nAfter DEM settles, run a pass that detects and fills gaps by moving nearby particles.\n\n## Testing\n1. Drop large pile of particles, let settle\n2. Visual inspection for gaps\n3. Count isolated particles (particles with \u003c3 contacts)\n\n## Priority\nP3 - Visual polish, not physics-critical","status":"closed","priority":3,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:34.920628+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:30:22.121055+10:00","closed_at":"2026-01-19T22:30:22.121055+10:00","close_reason":"Increased resolve_dem_penetrations from 2 to 6 iterations for better settling"}
{"id":"sluice-jaz","title":"GPU-CPU roundtrip inefficiency","description":"Grid velocities round-trip through CPU. Wastes 290KB/frame. Share buffers between P2G and G2P.","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:23.119341+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T21:24:18.864656+10:00","closed_at":"2026-01-19T21:24:18.864656+10:00","close_reason":"Removed unused grid velocity staging buffers from P2G. Grid data already stays on GPU - G2P reads directly from P2G output buffers via GPU buffer sharing. Removed: grid_u/v/w_staging buffers, download() method, and read_staging_buffer() helper."}
{"id":"sluice-l70","title":"P2G momentum ignores particle mass (density)","description":"## Problem\nP2G accumulates (vel + C*offset) * weight, but doesn't multiply by particle mass. Sediment (density \u003e 1) contributes same momentum as water.\n\n## Location\n`p2g_scatter_3d.wgsl` lines 160-171\n\n## Physics\nFLIP/APIC should use: momentum = m_p * w * (v_p + C_p * offset)\nwhere m_p = density * volume_per_particle\n\n## Impact\nSediment doesn't contribute proportionally more momentum to grid.\n\n## Fix\nAdd mass weighting: let mass = density * particle_volume.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:09.807487+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:44:34.116623+10:00","closed_at":"2026-01-19T20:44:34.116623+10:00","close_reason":"Added mass (density) weighting to P2G scatter shader - momentum now = density * (vel + C*offset) * weight"}
{"id":"sluice-mqx","title":"world.rs: Extract erosion.rs (deduplicate 70% World/FineRegion overlap)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:38:11.313859+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:38:11.313859+10:00","dependencies":[{"issue_id":"sluice-mqx","depends_on_id":"sluice-xny","type":"blocks","created_at":"2026-01-19T23:39:56.618878+10:00","created_by":"doctorspritz"},{"issue_id":"sluice-mqx","depends_on_id":"sluice-f7k","type":"blocks","created_at":"2026-01-19T23:39:56.825752+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-qqo","title":"flip_3d: Extract simulation.rs (run_gpu_passes → phase functions)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:37:56.038847+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:37:56.038847+10:00","dependencies":[{"issue_id":"sluice-qqo","depends_on_id":"sluice-8jt","type":"blocks","created_at":"2026-01-19T23:39:49.98454+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-ruo","title":"flip_3d: Extract readback.rs (async GPU→CPU transfer)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:37:53.023252+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:37:53.023252+10:00"}
{"id":"sluice-rzl","title":"Fast sweeping produces Manhattan distances, not Euclidean","description":"## Problem\nSDF generation uses fast sweeping which propagates axis-aligned distances. At corners/edges, distances are overestimated (Manhattan instead of Euclidean).\n\n## Location\n`crates/sim3d/src/grid.rs` lines 471-476:\n```rust\nlet nval = self.sdf[nidx];\nif val \u003e= 0.0 \u0026\u0026 nval \u003e= 0.0 {\n    self.sdf[idx] = self.sdf[idx].min(nval + dx);  // Manhattan!\n} else if val \u003c 0.0 \u0026\u0026 nval \u003c 0.0 {\n    self.sdf[idx] = self.sdf[idx].max(nval - dx);\n}\n```\n\n## Impact\n- Particles can approach corners more closely than expected\n- Collision normals at corners may point in wrong direction\n- Diagonal distance to corner is sqrt(2)*dx ≈ 1.414*dx but fast sweeping gives 2*dx\n\n## Implementation Fix\n**Option A (Eikonal update):** Replace `nval + dx` with proper Eikonal solver:\n```rust\n// For 3D, solve: |∇φ| = 1\n// Use upwind scheme with min of axis-aligned neighbors\nlet phi_x = self.sdf[x_neighbor].min(self.sdf[x_other_neighbor]);\nlet phi_y = self.sdf[y_neighbor].min(self.sdf[y_other_neighbor]);\nlet phi_z = self.sdf[z_neighbor].min(self.sdf[z_other_neighbor]);\n// Solve quadratic: (φ-φ_x)² + (φ-φ_y)² + (φ-φ_z)² = dx²\n```\n\n**Option B (Post-process):** Keep fast sweeping for initialization, then run 2-3 Gauss-Seidel Eikonal iterations\n\n## Testing\n1. Create a box SDF, sample diagonal corner - should be sqrt(3)*dx from corner, not 3*dx\n2. Unit test: `assert!((corner_sdf - expected_euclidean).abs() \u003c 0.01 * dx)`\n\n## Risk\nMedium - affects all SDF-based collision. Test thoroughly.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:09.171758+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T21:15:56.171608+10:00","closed_at":"2026-01-19T21:15:56.171608+10:00","close_reason":"Fixed and merged to main"}
{"id":"sluice-s70","title":"[Epic] Refactor world.rs (3386 lines → 7 modules)","status":"open","priority":2,"issue_type":"feature","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:37:41.435341+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:37:41.435341+10:00"}
{"id":"sluice-szr","title":"detail_zone example has 15 compile errors - missing struct fields","description":"The `detail_zone` example fails to compile with 15 errors.\n\n**Error Summary:**\n```\nerror[E0560]: struct `App` has no field named `detail_emitter_mesh`\nerror[E0560]: struct `App` has no field named `detail_emitter_pos`\nerror[E0609]: no field `detail_emitter_pos` on type `\u0026mut App`\nerror[E0609]: no field `detail_emitter_mesh` on type `\u0026mut App`\n```\n\n**Root Cause:**\nThe `App` struct (line 287-328) is missing two fields that are used throughout the code:\n- `detail_emitter_mesh: Option\u003cMesh\u003e`\n- `detail_emitter_pos: Vec3`\n\nThese fields are referenced in the struct initialization (lines 472-473) and accessed in multiple methods (lines 800, 801, 820, 829, 838, 893, 894, 1547, 1807, 1809, 1813).\n\n**Fix:**\nAdd the missing fields to the `App` struct definition:\n```rust\nstruct App {\n    // ... existing fields ...\n    detail_emitter_mesh: Option\u003cMesh\u003e,\n    detail_emitter_pos: Vec3,\n}\n```\n\n**Impact:**\n- Blocks `cargo test` from running all examples\n- Example is unusable\n\n**File:**\n- crates/game/examples/detail_zone.rs","status":"closed","priority":3,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T20:12:05.867963+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:16:34.092513+10:00","closed_at":"2026-01-19T20:16:34.092513+10:00","close_reason":"Fixed: Increased max_erosion_per_step from 0.00001 to 0.001 so physics-based rates dominate; Added missing struct fields and constant to detail_zone.rs"}
{"id":"sluice-t3n","title":"CRITICAL: DEM desynchronized from FLIP substeps","description":"## Problem\nDEM collision response runs ONCE per frame with full dt (1/60s), while FLIP runs 2 substeps. Also, DEM critical timestep is 0.004s but collision_response_only uses 0.0167s (4x above critical).\n\n## Location\n- `main.rs` line 651: run_dem_and_cleanup called once per frame\n- `clump.rs` line 377-378: substeps = 8 in step(), but collision_response_only has no substeps\n\n## Impact\n- Sediment particles penetrate solids between DEM calls\n- DEM spring-damper is unstable at 4x critical timestep\n- FLIP and DEM are out of sync\n\n## Fix\nMove DEM collision response inside FLIP substep loop, use dt_sub not full dt.","status":"closed","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:05.952478+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:12:13.03938+10:00","closed_at":"2026-01-19T19:12:13.03938+10:00","close_reason":"Fixed all P0 issues: cell type constants, pressure diagonal, CFL violation, DEM desync, SDF/cell type coupling"}
{"id":"sluice-tem","title":"Consider SoA particle layout","description":"64-byte struct but most loops need 16 bytes. Defer until 100K+ particles.","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:15:24.461247+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T21:48:16.558014+10:00","closed_at":"2026-01-19T21:48:16.558014+10:00","close_reason":"GPU already uses SoA (separate position/velocity/density buffers). CPU Particle3D struct only used for init/upload, not hot paths. No CPU-side simulation planned."}
{"id":"sluice-thw","title":"Sediment settling velocity scaling error (~18x amplification)","description":"## Problem\nSettling velocity calculation has incorrect scaling. For gold particles (density 19300 kg/m³), the current formula produces ~18x amplification versus physical reality.\n\n## Location\n`crates/sim3d/src/world.rs` - settling velocity calculation\n\n## Impact\nGold settles unrealistically fast, affecting gameplay balance.\n\n## Solution\nReview Stokes law implementation and unit conversions.","status":"closed","priority":2,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:58.643902+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T20:44:35.762074+10:00","closed_at":"2026-01-19T20:44:35.762074+10:00","close_reason":"Code was already correct; fixed documentation (2/9 vs 1/18 formula) and added settling velocity validation test"}
{"id":"sluice-u3f","title":"Sediment particle index corruption after swap_remove","description":"## Problem\nWhen particles are removed via `swap_remove`, the index of the swapped particle changes but references in sediment mapping may not be updated.\n\n## Location\n`crates/game/src/main.rs` line 779 area - sediment particle management\n\n## Risk\nWrong particles receive sediment, physics corruption.\n\n## Solution\nUse stable indices (arena/generational) or update all references after swap.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:34:32.834357+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:45:20.337941+10:00","closed_at":"2026-01-19T19:45:20.337941+10:00","close_reason":"Analyzed: swap_remove logic is correct - parallel arrays swap at same position, maintaining correspondence"}
{"id":"sluice-vl7","title":"Fix gravity sign bug in swe_physics test","description":"## Problem\nIn crates/sim3d/tests/swe_physics.rs:12, gravity is defined as positive `9.81` instead of negative `-9.81`.\n\n## Impact\nTest uses wrong physics constants, may pass incorrectly.","status":"closed","priority":1,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:05.247087+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:13:00.885543+10:00","closed_at":"2026-01-19T23:13:00.885543+10:00","close_reason":"Fixed in commit 096cb54"}
{"id":"sluice-xmw","title":"Refactor world.rs god file (3386 lines)","description":"## Problem\nworld.rs is 3386 lines mixing 4+ physics systems.\n\n## Suggested breakdown\n- world/terrain_model.rs - heightfield ops\n- world/shallow_water.rs - water flow physics\n- world/sediment.rs - settling, erosion, advection\n- world/materials.rs - material properties\n\n## Impact\nImpossible to understand which system handles what. Adding new physics mixes concerns.","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:26.967553+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:43:24.604823+10:00","closed_at":"2026-01-19T23:43:24.604823+10:00","close_reason":"Superseded by epics sluice-13n and sluice-s70 with detailed subtasks"}
{"id":"sluice-xny","title":"world.rs: Extract physics.rs (Shields, settling, shear calculations)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:38:09.08632+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:38:09.08632+10:00"}
{"id":"sluice-xsw","title":"world.rs: Extract sediment.rs (advection, settling, transport)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T23:38:12.082243+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:38:12.082243+10:00","dependencies":[{"issue_id":"sluice-xsw","depends_on_id":"sluice-f7k","type":"blocks","created_at":"2026-01-19T23:39:57.036677+10:00","created_by":"doctorspritz"}]}
{"id":"sluice-yf7","title":"Refactor flip_3d.rs god file (5216 lines)","description":"## Problem\nflip_3d.rs is 5216 lines with a 2580-line constructor and 993-line run_gpu_passes function.\n\n## Suggested breakdown\n- flip_3d/params.rs - all parameter structs (200+ lines)\n- flip_3d/resources.rs - GPU buffer management\n- flip_3d/diagnostics.rs - debug/physics diagnostics\n- flip_3d/stages.rs - compute stage dispatch\n\n## Impact\nUnmaintainable. Adding new GPU features requires navigating 2500+ line function.","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T22:58:26.178186+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T23:43:24.60248+10:00","closed_at":"2026-01-19T23:43:24.60248+10:00","close_reason":"Superseded by epics sluice-13n and sluice-s70 with detailed subtasks"}
{"id":"sluice-z4l","title":"CRITICAL: CFL violation - grid clamp at 10m/s allows CFL=8.3","description":"## Problem\nGrid velocity is clamped at 10 m/s, but with cell_size=0.01m and dt_sub=1/120s, CFL should be \u003c 1.0.\n\n## Math\nCFL = v * dt / dx = 10 * 0.0083 / 0.01 = 8.3 (should be \u003c 1)\nComment in code says dx=0.025m but actual cell_size is 0.01m.\n\n## Location\n`sim3d/src/lib.rs` lines 204-225: MAX_GRID_VEL = 10.0\n\n## Impact\nParticles can advect 8+ cells per substep. Causes tunneling, instability.\n\n## Fix\nLower MAX_GRID_VEL to ~1.0 m/s OR use adaptive timestep.","status":"closed","priority":0,"issue_type":"bug","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T18:50:05.274815+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T19:12:13.03787+10:00","closed_at":"2026-01-19T19:12:13.03787+10:00","close_reason":"Fixed all P0 issues: cell type constants, pressure diagonal, CFL violation, DEM desync, SDF/cell type coupling"}
{"id":"sluice-znq","title":"Visual regression tests","description":"## Goal\nCatch rendering bugs via screenshot comparison.\n\n## Tests to add\n1. **Fluid rendering** - Compare rendered frame against reference image\n2. **Particle positions** - Verify particles render at expected locations\n3. **Sediment coloring** - Density-based coloring correct\n4. **SDF boundaries** - Solid surfaces render correctly\n\n## Approach\n- Render to offscreen texture in headless mode\n- Save PNG, compare against checked-in reference\n- Use perceptual diff (allow small tolerance for GPU differences)\n- Store references in `tests/visual_references/`\n\n## Tools\n- `image` crate for PNG comparison\n- Consider `pixelmatch` or similar for perceptual diff\n- Headless wgpu context (already have this)\n\n## Scenarios\n- Dam break at t=0, t=1s, t=2s\n- Settled particles in box\n- Sediment stratification","status":"closed","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-01-19T21:55:13.269163+10:00","created_by":"doctorspritz","updated_at":"2026-01-19T22:05:09.895646+10:00","closed_at":"2026-01-19T22:05:09.895646+10:00","close_reason":"3 visual regression tests implemented","dependencies":[{"issue_id":"sluice-znq","depends_on_id":"sluice-7or","type":"blocks","created_at":"2026-01-19T21:56:27.876389+10:00","created_by":"doctorspritz"}]}
